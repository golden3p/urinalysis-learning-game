<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urinalysis Sediment Coach v8.5</title>
    <style>
        /* --- CSS Styles --- */
        :root {
            --primary-color: #0056b3;
            --junior-color: #28a745;   /* Green */
            --advanced-color: #d63384; /* Pink */
            --quiz-color: #e67e22;     /* Orange */
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        * { box-sizing: border-box; font-family: "Microsoft JhengHei", "Helvetica Neue", Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        .app-container {
            background: var(--card-bg); width: 100%; max-width: 900px;
            border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden; display: flex; flex-direction: column;
            position: relative; min-height: 850px;
        }

        /* Screen Visibility */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; flex-grow: 1; }
        .screen.active { display: flex; }

        /* Start Screen */
        #start-screen {
            padding: 30px; text-align: center; justify-content: flex-start; align-items: center;
            background: linear-gradient(135deg, #ffffff 0%, #eef2f3 100%);
            overflow-y: auto;
        }
        .title-area { margin-bottom: 25px; margin-top: 20px; }
        .title-area h1 { color: var(--primary-color); margin-bottom: 5px; font-size: 2.2rem; }
        
        .mode-selection {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; margin-bottom: 30px;
        }
        .mode-card {
            background: white; border: 2px solid #eee; border-radius: 15px; padding: 20px;
            cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        }
        .mode-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .mode-card.junior:hover { border-color: var(--junior-color); }
        .mode-card.advanced:hover { border-color: var(--advanced-color); }
        .mode-card.quiz:hover { border-color: var(--quiz-color); }

        .mode-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .mode-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 8px; }
        .mode-desc { font-size: 0.85rem; color: #666; line-height: 1.4; }
        
        .mode-card.junior .mode-title { color: var(--junior-color); }
        .mode-card.advanced .mode-title { color: var(--advanced-color); }
        .mode-card.quiz .mode-title { color: var(--quiz-color); }

        /* --- Footer & Copyright Area --- */
        .footer-area {
            margin-top: auto;
            width: 100%;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
            padding-bottom: 10px;
        }
        
        .author-name {
            font-size: 1.1rem; color: var(--primary-color); font-weight: bold; margin-bottom: 5px;
        }
        .author-dept {
            font-size: 0.95rem; color: #444; margin-bottom: 15px; line-height: 1.4;
        }
        .author-dept-en {
            font-size: 0.85rem; color: #666; display: block; margin-top: 2px;
        }

        .copyright-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.8rem;
            color: #666;
            line-height: 1.5;
            text-align: left;
            margin-top: 10px;
        }
        .copyright-box p { margin: 5px 0; }
        /* ------------------------------- */

        /* Game Interface */
        .header { padding: 15px 30px; background: #fff; border-bottom: 1px solid #eee; }
        .header-top { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        .mode-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; color: white; vertical-align: middle; margin-right: 5px; font-weight: normal;}
        
        .progress-track { width: 100%; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.4s ease; background-color: var(--primary-color); }

        .game-content { padding: 20px; text-align: center; flex-grow: 1; overflow-y: auto; }

        /* Microscope Lens (Full View) */
        .microscope-lens {
            width: 100%;
            max-width: 600px; 
            height: 400px;
            background-color: #000;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin: 0 auto 20px auto;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .microscope-lens img { width: 100%; height: 100%; object-fit: contain; display: block; }
        .img-error-msg { position: absolute; text-align: center; padding: 20px; font-size: 0.9rem; color: #ff6b6b; display: none; width: 100%; top: 50%; transform: translateY(-50%); }

        .question-text { 
            font-size: 1.1rem; color: var(--text-color); margin-bottom: 20px; font-weight: 600; min-height: 70px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .lab-data-tag {
            background: #f0f4f8; border: 1px solid #dceefb; color: #0056b3; 
            padding: 5px 12px; border-radius: 6px; font-size: 0.9rem; margin-top: 8px; font-family: monospace;
        }

        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .option-btn {
            padding: 12px; background: #fff; border: 2px solid #e0e0e0; border-radius: 10px;
            font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.2s; color: #444; word-wrap: break-word;
        }
        .option-btn:hover:not(:disabled) { border-color: var(--primary-color); color: var(--primary-color); background: #f8fbff; }
        .option-btn.correct { background-color: #d4edda !important; border-color: #28a745 !important; color: #155724 !important; }
        .option-btn.wrong { background-color: #f8d7da !important; border-color: #dc3545 !important; color: #721c24 !important; opacity: 0.6; }

        .feedback-panel {
            margin-top: 20px; padding: 15px; border-radius: 10px; text-align: left; display: none;
            background-color: #fff3cd; border-left: 5px solid #ffc107; color: #856404; animation: fadeIn 0.3s; font-size: 0.95rem;
        }
        .feedback-panel.success { background-color: #d4edda; border-left-color: #28a745; color: #155724; }
        .feedback-panel.error { background-color: #f8d7da; border-left-color: #dc3545; color: #721c24; }

        .next-btn {
            margin-top: 20px; padding: 12px; width: 100%; background: var(--primary-color); color: white;
            border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; display: none;
        }

        #result-screen { display: none; padding: 40px; text-align: center; justify-content: center; align-items: center; }
        .score-circle { 
            width: 140px; height: 140px; border-radius: 50%; background: var(--primary-color); color: white;
            display: flex; justify-content: center; align-items: center; font-size: 3.5rem; font-weight: bold; margin: 20px auto;
        }
        .home-btn { 
            margin-top: 10px; background: transparent; color: #666; border: 1px solid #ccc; padding: 10px 30px; border-radius: 50px; cursor: pointer;
        }
        .home-btn:hover { background: #eee; }

        @media (max-width: 700px) { 
            .mode-selection { grid-template-columns: 1fr; } 
            .options-grid { grid-template-columns: 1fr; }
            .microscope-lens { height: 300px; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="start-screen" class="screen active">
            <div class="title-area">
                <h1>å°¿æ¶²æ²‰æ¸£é¡æª¢æ•™ç·´</h1>
                <h2>Urinalysis Sediment Coach <span style="font-size:0.7em; background:#333; color:#fff; padding:2px 6px; border-radius:4px;">v8.5</span></h2>
            </div>
            
            <p style="margin-bottom: 20px; color: #555;">è«‹é¸æ“‡æ¨¡å¼ (Select Mode)ï¼š</p>

            <div class="mode-selection">
                <div class="mode-card junior" onclick="startGame('junior')">
                    <span class="mode-icon">ğŸ”°</span>
                    <span class="mode-title">åˆç´šæ•™ç·´</span>
                    <span class="mode-desc">åŸºç¤é¡Œåº« (å…¨åš)</span>
                </div>
                <div class="mode-card advanced" onclick="startGame('advanced')">
                    <span class="mode-icon">ğŸ”¥</span>
                    <span class="mode-title">é€²éšæ•™ç·´</span>
                    <span class="mode-desc">éš¨æ©ŸæŠ½ 20 é¡Œ</span>
                </div>
                <div class="mode-card quiz" onclick="startGame('quiz')">
                    <span class="mode-icon">ğŸ“</span>
                    <span class="mode-title">æ¸¬è©¦ä¸€ä¸‹</span>
                    <span class="mode-desc" style="color:#e67e22; font-weight:bold;">æ··åˆæŠ½é¡Œ (ç„¡æç¤º)</span>
                </div>
            </div>

            <div class="footer-area">
                <div class="author-name">å¼µæ˜±ç¶­ åŠ©ç†æ•™æˆ</div>
                <div class="author-dept">
                    ä¸­å±±é†«å­¸å¤§å­¸ é†«å­¸æª¢é©—æš¨ç”Ÿç‰©æŠ€è¡“å­¸ç³»<br>
                    <span class="author-dept-en">Department of Medical Laboratory and Biotechnology, CSMU</span>
                </div>
                
                <div class="copyright-box">
                    <p>æœ¬è¨“ç·´å™¨æ˜¯ç”±å¼µæ˜±ç¶­åŠ©ç†æ•™æˆæ”¶é›†è‡ªæŒ‡å®šæ•™ç§‘æ›¸åŠå°ˆæ¥­ç¶²ç«™åœ–è­œï¼Œé…åˆ Gemini 3.0 Pro LLM å”ä½œç”Ÿæˆã€‚</p>
                    <p>ä¾›ä¿®ç¿’æœ¬å­¸æœŸè‡¨åºŠé¡æª¢å­¸(å«å¯¦é©—èª²)ä¹‹ä¸­å±±é†«å­¸å¤§å­¸é†«æŠ€ç³»åŒå­¸ä»¥å­¸ç¿’ç›®ä½¿ç”¨ä¹‹ï¼Œç´”æ•™è‚²ç”¨é€”ï¼Œç„¡ç‡Ÿåˆ©èˆ‡å•†è½‰ç›®çš„ï¼Œäº¦è«‹ä½¿ç”¨è€…å‹¿è½‰ä½œå…¶ä»–ç”¨é€”ï¼Œä»¥å…è§¸æ³•ã€‚</p>
                    <p>å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹èˆ‡å°ˆæ¥­æ•™å¸«è¨è«–è«®è©¢ï¼Œä¸¦è«‹åƒè€ƒæ­£ç‰ˆæ•™ç§‘æ›¸èªªæ˜å…§å®¹ã€‚</p>
                </div>
            </div>
        </div>

        <div id="game-interface" class="screen">
            <div class="header">
                <div class="header-top">
                    <div>
                        <span id="mode-badge" class="mode-badge">Mode</span>
                        <span id="progress-text">Q 1 / 10</span>
                    </div>
                    <span id="score-text" style="color:var(--primary-color);">Score: 0</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="progress-bar"></div>
                </div>
            </div>

            <div class="game-content">
                <div class="microscope-lens">
                    <img id="question-image" src="" alt="Microscope View" onerror="handleImageError(this)">
                    <div id="error-msg" class="img-error-msg">âš ï¸ Image Not Found<br><span id="missing-filename" style="font-size:0.8em; color:#fff;"></span></div>
                </div>

                <div class="question-text" id="question-text"></div>
                <div class="options-grid" id="options-container"></div>
                <div id="feedback-panel" class="feedback-panel"></div>
                <button id="next-btn" class="next-btn" onclick="nextQuestion()">Next Question â”</button>
            </div>
        </div>

        <div id="result-screen" class="screen">
            <h2 id="result-title">çµç®—</h2>
            <div class="score-circle" id="final-score">0</div>
            <h3 id="final-rank" style="color:var(--primary-color); margin: 10px 0;">Rank</h3>
            <p id="final-comment" style="color:#555; max-width: 400px; margin: 0 auto 30px auto; line-height: 1.5;"></p>
            <button class="next-btn" style="display:inline-block; width:auto; padding: 12px 40px; margin-bottom:10px;" onclick="restartGame()">å†ä¾†ä¸€å±€ (Replay)</button><br>
            <button class="home-btn" onclick="goHome()">å›é¦–é  (Home)</button>
        </div>
    </div>

    <script>
        // --- 1. JUNIOR POOL ---
        const juniorPool = [
            { id: "j01", image_file: "images/rbc_01.jpg", options: ["RBC", "WBC", "Yeast", "Air Bubble"], correct_index: 0, question: "ã€400xã€‘è¦–é‡ä¸­å¯è¦‹é›™å‡¹åœ“ç›¤ç‹€ã€ç„¡ç´°èƒæ ¸ä¸”é‚Šç·£å¹³æ»‘çš„ç´°èƒã€‚", explanation: "<strong>RBC</strong>ï¼šç„¡æ ¸ã€é›™å‡¹åœ“ç›¤ç‹€ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | OB: 3+" },
            { id: "j02", image_file: "images/wbc_01.jpg", options: ["WBC", "RBC", "RTEC", "Yeast"], correct_index: 0, question: "ã€400xã€‘ç´°èƒæ¯”ç´…è¡€çƒç¨å¤§ï¼Œè³ªå…§æœ‰é¡†ç²’ï¼Œä¾ç¨€å¯è¦‹åˆ†è‘‰æ ¸ã€‚", explanation: "<strong>WBC</strong>ï¼šå…·é¡†ç²’æ€§ç´°èƒè³ªèˆ‡åˆ†è‘‰æ ¸ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 7.0 | LE: 2+" },
            { id: "j03", image_file: "images/sq_epi_01.jpg", options: ["Squamous Epithelial Cell", "Urothelial Cell", "Mucus", "Cast"], correct_index: 0, question: "ã€400xã€‘é«”ç©å·¨å¤§ã€å½¢ç‹€ä¸è¦å‰‡çš„æ‰å¹³ç´°èƒã€‚", explanation: "<strong>Squamous Epi</strong>ï¼šé«”ç©æœ€å¤§ï¼Œå¸¸è¦‹å¥³æ€§å¤–é™°éƒ¨ç´°èƒè„«è½ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.5 | Epithelial cells: 10-19/HPF" },
            { id: "j04", image_file: "images/yeast_01.jpg", options: ["Yeast", "RBC", "CaOx", "Bacteria"], correct_index: 0, question: "ã€400xã€‘æ©¢åœ“å½¢ç´°èƒï¼Œå¤§å°ä¸å‡ä¸€ï¼Œå…·ã€Œå‡ºèŠ½ã€ç‰¹å¾µã€‚", explanation: "<strong>Yeast</strong>ï¼šå‡ºèŠ½ç”Ÿæ®–ï¼Œä¸æº¶æ–¼é…¸ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 5.5 | Glucose: 3+" },
            { id: "j05", image_file: "images/bacteria_01.jpg", options: ["Bacteria", "Amorphous Phos", "Sperm", "Yeast"], correct_index: 0, question: "ã€400xã€‘èƒŒæ™¯å……æ»¿å¾®å°æ¡¿ç‹€æˆ–çƒç‹€ç‰©ï¼Œå…·å¸ƒæœ—é‹å‹•ã€‚", explanation: "<strong>Bacteria</strong>ï¼šå¤§é‡å‡ºç¾æç¤ºæ„ŸæŸ“ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 7.5 | Nitrite: +" },
            { id: "j06", image_file: "images/caox_01.jpg", options: ["Calcium Oxalate", "Uric Acid", "Triple Phos", "Cholesterol"], correct_index: 0, question: "ã€400xã€‘é…¸æ€§å°¿ï¼ŒæŠ˜å…‰æ€§å¼·ï¼Œå‘ˆç¾ã€Œä¿¡å°ç‹€ã€çµæ™¶ã€‚", explanation: "<strong>Ca Oxalate</strong>ï¼šå…«é¢é«”ä¿¡å°ç‹€ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 5.5 | Clear" },
            { id: "j07", image_file: "images/trip_phos_01.jpg", options: ["Triple Phosphate", "Ca Carbonate", "Cystine", "Tyrosine"], correct_index: 0, question: "ã€400xã€‘é¹¼æ€§å°¿ï¼Œå‘ˆç¾ã€Œæ£ºæè“‹ç‹€ã€é•·æ–¹å½¢çµæ™¶ã€‚", explanation: "<strong>Triple Phosphate</strong>ï¼šç£·é…¸éŠ¨é‚ï¼Œé¹¼æ€§å°¿å¸¸è¦‹ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 8.0" },
            { id: "j08", image_file: "images/uric_acid_01.jpg", options: ["Uric Acid", "Bilirubin", "Cystine", "Leucine"], correct_index: 0, question: "ã€400xã€‘é…¸æ€§å°¿ï¼Œé»ƒè¤è‰²ï¼Œå½¢ç‹€å¤šè®Šï¼ˆè±å½¢ã€èŠ±ç‹€ï¼‰ã€‚", explanation: "<strong>Uric Acid</strong>ï¼šé¡è‰²åé»ƒï¼Œç—›é¢¨å¸¸è¦‹ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 5.0" },
            { id: "j09", image_file: "images/hyaline_01.jpg", options: ["Hyaline Cast", "Granular Cast", "Waxy Cast", "Fatty Cast"], correct_index: 0, question: "ã€400xã€‘éå¸¸é€æ˜ã€å…©å´å¹³è¡Œã€æŠ˜å…‰æ€§ä½ã€‚", explanation: "<strong>Hyaline Cast</strong>ï¼šé€æ˜åœ“æŸ±é«”ã€‚", stain_info: "400x / Low Light", chem_context: "pH: 6.0 | Protein: 1+" },
            { id: "j10", image_file: "images/granular_01.jpg", options: ["Granular Cast", "WBC Cast", "RBC Cast", "Broad Cast"], correct_index: 0, question: "ã€400xã€‘åœ“æŸ±é«”åŸºè³ªå…§å……æ»¿ç²—å¤§æˆ–ç´°å°é¡†ç²’ã€‚", explanation: "<strong>Granular Cast</strong>ï¼šé¡†ç²’ä¾†è‡ªç´°èƒå´©è§£ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | Protein: 2+" },
            { id: "j11", image_file: "images/mucus_01.jpg", options: ["Mucus", "Hyaline Cast", "Fiber", "Cylindroid"], correct_index: 0, question: "ã€200xã€‘ç´°é•·ã€æ³¢æµªç‹€ã€å¸¶ç‹€ç·šæ¢ï¼ŒæŠ˜å…‰æ€§ä½ã€‚", explanation: "<strong>Mucus</strong>ï¼šé»æ¶²çµ²ï¼Œé‚Šç·£ä¸è¦å‰‡ã€‚", stain_info: "200x / Unstained", chem_context: "pH: 6.0" },
            { id: "j12", image_file: "images/amorph_urates.jpg", options: ["Amorphous Urates", "Amorphous Phos", "Bacteria", "Yeast"], correct_index: 0, question: "ã€400xã€‘é…¸æ€§å°¿ï¼Œè‚‰çœ¼çœ‹æ²ˆæ¾±ç‰©å‘ˆç²‰ç´…è‰² (Brick dust)ï¼Œé¡ä¸‹ç‚ºé»ƒè‰²ç´°æ²™ç‹€ã€‚", explanation: "<strong>Amorphous Urates</strong>ï¼šé…¸æ€§å°¿ç„¡å®šå½¢é¹½ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 5.0 | Brick Dust" },
            { id: "j13", image_file: "images/starch_01.jpg", options: ["Starch", "Leucine", "Cholesterol", "Air Bubble"], correct_index: 0, question: "ã€400xã€‘æœ‰æ˜é¡¯æŠ˜å°„æ€§ï¼Œå¤šé‚Šå½¢ï¼Œä¸­å¤®æœ‰ Y å­—å½¢è£‚ç—•ã€‚", explanation: "<strong>Starch</strong>ï¼šæ¾±ç²‰é¡†ç²’ï¼ˆæ»‘çŸ³ç²‰ï¼‰ã€‚", stain_info: "400x / Unstained", chem_context: "Contamination" },
            { id: "j14", image_file: "images/cystine_01.jpg", options: ["Cystine", "Cholesterol", "Triple Phos", "Uric Acid"], correct_index: 0, question: "ã€400xã€‘é…¸æ€§å°¿ï¼Œç„¡è‰²ã€å…­è§’å½¢è–„ç‰‡ã€‚", explanation: "<strong>Cystine</strong>ï¼šå…­è§’å½¢çµæ™¶ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 5.0" },
            { id: "j15", image_file: "images/trich_01.jpg", options: ["Trichomonas", "WBC", "Bacteria", "RTEC"], correct_index: 0, question: "ã€400xã€‘å¸¸è¦‹å¯„ç”ŸèŸ²ï¼Œä¼¼ç™½è¡€çƒå‹æ…‹ï¼Œå…·é­æ¯›ï¼Œæœ‰æ¸¸å‹•æ€§ã€‚", explanation: "<strong>Trichomonas</strong>ï¼šé™°é“æ»´èŸ²ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 7.0" },
            { id: "j16", image_file: "images/ca_carb.jpg", options: ["Calcium Carbonate", "Calcium Oxalate", "Triple Phosphate", "Uric Acid"], correct_index: 0, question: "ã€400xã€‘å‡ºç¾æ–¼é¹¼æ€§å°¿ï¼Œæœ‰'8å­—å‹'å½¢æ…‹æˆ–è¼»å°„ç‹€å°åœ“å½¢æ…‹ï¼ŒåŠ é…¸æœƒç”¢ç”ŸCO2æ°£æ³¡ã€‚", explanation: "<strong>Calcium carbonate</strong>ï¼šé¹¼æ€§å°¿å¸¸è¦‹ï¼Œç‰¹å¾µæ˜¯å•éˆ´ç‹€ä¸”é‡é…¸ç”¢æ°£ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 8.0 | Bubbles with acid" },
            { id: "j17", image_file: "images/amorph_phos.jpg", options: ["Amorphous Phosphate", "Amorphous Urates", "Bacteria", "Mucus"], correct_index: 0, question: "ã€400xã€‘å°¿æ¶²é›¢å¿ƒå¾Œæœ‰ç™½è‰²æ²‰æ¾±ï¼Œé¹¼æ€§å°¿ä¸­å¸¸è¦‹çš„ä¸å®šå½¢é¹½é¡ã€‚", explanation: "<strong>Amorphous phosphate</strong>ï¼šé¹¼æ€§å°¿ä¸­çš„ç„¡å®šå½¢ç£·é…¸é¹½ï¼Œå¤–è§€ç‚ºç™½è‰²æ²‰æ¾±ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 8.0 | White Sediment" },
            { id: "j18", image_file: "images/amm_biurate.jpg", options: ["Ammonium Biurate", "Leucine", "Tyrosine", "Sulfonamide"], correct_index: 0, question: "ã€400xã€‘é¹¼æ€§å°¿çµæ™¶ï¼Œå‘ˆåˆºè˜‹æœ'Thorn apple'ç‹€ï¼Œèˆ‡å°¿æ¶²ä¹…ç½®ç›¸é—œã€‚", explanation: "<strong>Ammonium biurate</strong>ï¼šé‡å°¿é…¸éŠ¨ï¼Œç‰¹å¾µæ€§çš„åˆºè˜‹æœå¤–è§€ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 8.5 | Old Urine" },
            { id: "j19", image_file: "images/leucine.jpg", options: ["Leucine", "Tyrosine", "Fat Droplet", "Starch"], correct_index: 0, question: "ã€400xã€‘é»ƒè¤è‰²æ²¹æ»´ç‹€çƒé«”ï¼Œå…·æœ‰æ˜é¡¯çš„åŒå¿ƒåœ“æ¢ç´‹ã€‚", explanation: "<strong>Leucine</strong>ï¼šç™½èƒºé…¸çµæ™¶ã€‚è¦‹æ–¼åš´é‡è‚ç—…ï¼Œå¸¸èˆ‡ Tyrosine ä¸¦å­˜ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 5.5 | åš´é‡è‚ç—…" },
            { id: "j20", image_file: "images/tyrosine.jpg", options: ["Tyrosine", "Calcium Phosphate", "Bilirubin", "Uric Acid"], correct_index: 0, question: "ã€400xã€‘ç„¡è‰²æˆ–æ·¡é»ƒè‰²ç´°é‡ç‹€ï¼Œå¸¸èšé›†æˆæŸ (Sheaves) æˆ–èŠèŠ±ç‹€ã€‚", explanation: "<strong>Tyrosine</strong>ï¼šé…ªèƒºé…¸çµæ™¶ã€‚ç´°é‡æŸç‹€ï¼Œè¦‹æ–¼åš´é‡è‚ç—…ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 5.5 | Bilirubin: 3+" },
            { id: "j21", image_file: "images/cholesterol.jpg", options: ["Cholesterol", "Cystine", "Triple Phosphate", "Radiographic Dye"], correct_index: 0, question: "ã€400xã€‘ç„¡è‰²ã€é•·æ–¹å½¢è–„ç‰‡ï¼Œè§’è½æœ‰ç¼ºè§’ (Notched corners)ï¼Œå‘ˆç¾éšæ¢¯ç‹€ã€‚", explanation: "<strong>Cholesterol</strong>ï¼šè†½å›ºé†‡çµæ™¶ã€‚ç‰¹å¾µç¼ºè§’é•·æ–¹æ¿ç‹€ï¼Œè¦‹æ–¼è…ç—…ç—‡å€™ç¾¤ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | Protein: 4+ | Lipid: +" }
        ];

        // --- 2. ADVANCED POOL ---
        const advancedPool = [
            { id: "rbc_ghost", image_file: "images/rbc_ghost.jpg", options: ["RBC Ghost Cell", "Yeast", "Air Bubble", "WBC"], correct_index: 0, question: "ã€400xã€‘ä½æ¯”é‡å°¿æ¶²ä¸­ï¼Œç´°èƒè„¹ç ´ã€æµå¤± Hbï¼Œå‘ˆç¾ç„¡è‰²ç‹€çš„é¬¼å½±ç´°èƒã€‚", explanation: "<strong>RBC ghost cell</strong>ï¼šä½æ»²é€å£“å°¿æ¶²ä¸­ï¼ŒRBC æº¶è¡€å¾Œå‰©ä¸‹çš„ç´°èƒè†œç©ºæ®¼ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 7.0 | SG: 1.003 | OB: 2+" },
            { id: "sq_mid", image_file: "images/sq_mid.jpg", options: ["Deep Squamous Epi", "Middle Squamous Epi", "RTEC", "WBC"], correct_index: 1, question: "ã€400xã€‘ã€ç´…è‰²ç®­é ­è™•ã€‘ç´°èƒæ ¸ç´„ç™½è¡€çƒå¤§å°ã€ç½®ä¸­æˆ–å¾®åå¿ƒï¼Œç´°èƒè³ªäº›è¨±æ–‘é»ç‹€ï¼Œç´°èƒå‹æ…‹ä¸è¦å‰‡ã€‚", explanation: "<strong>ä¸­å±¤ Squamous epithelial cells</strong>ï¼šä¾†è‡ªä¸Šçš®ä¸­å±¤ï¼Œæ ¸è³ªæ¯”ç•¥å¤§æ–¼è¡¨å±¤ç´°èƒã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | Epithelial: ++" },
            { id: "sq_deep", image_file: "images/sq_deep.jpg", options: ["Middle Squamous Epi", "Deep Squamous Epi", "Urothelial Cell", "RTEC"], correct_index: 1, question: "ã€400xã€‘ç´°èƒæ ¸ç´„ç™½è¡€çƒå¤§å°ã€ç½®ä¸­æˆ–å¾®åå¿ƒï¼Œç´°èƒè³ªäº›è¨±æ–‘é»ç‹€ï¼Œç´°èƒå‘ˆåœ“åµå½¢ã€‚", explanation: "<strong>æ·±å±¤ Squamous epithelial cells</strong>ï¼šåˆç¨±åŸºåº•å±¤ç´°èƒï¼Œè¼ƒåœ“ï¼Œå°‘è¦‹ï¼Œéœ€èˆ‡ç§»è¡Œä¸Šçš®å€åˆ†ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | LE: -" },
            { id: "urothelial", image_file: "images/urothelial.jpg", options: ["Squamous Epi", "Urothelial Cell", "RTEC", "WBC"], correct_index: 1, question: "ã€400xã€‘æ¢¨å½¢ã€è±è§’å½¢æˆ–å‚˜ç‹€ï¼Œç´°èƒæ ¸ç´„ 1.5 å€ WBC å¤§ï¼Œå¤šæ ¸ï¼Œç´°èƒè³ªå‡¹å‡¸æ˜é¡¯ï¼Œæˆé¾œç”²æˆ–é¦¬è³½å…‹ç‹€ã€‚", explanation: "<strong>Urothelial cell (Transitional)</strong>ï¼šä¾†è‡ªè…ç›‚è‡³è†€èƒ±æ®µï¼Œå¤§é‡å‡ºç¾å¯èƒ½èˆ‡å°å°¿æˆ–ç™¼ç‚æœ‰é—œã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | Nitrite: -" },
            { id: "rtec", image_file: "images/rtec.jpg", options: ["WBC", "RTEC", "Urothelial Cell", "Squamous Epi"], correct_index: 1, question: "ã€400xã€‘ç´°èƒæ ¸ç´„ RBC å¤§å°ã€æ¥µåå¿ƒï¼Œç´°èƒè³ªé¡†ç²’å¤šã€é€æ˜åº¦å·®ï¼Œæœ€å¸¸è¦‹é‹¸é½’å‹ã€‚", explanation: "<strong>Renal tubular epithelial cell (RTEC)</strong>ï¼šä¾†è‡ªè…å°ç®¡ï¼Œæç¤ºè…å°ç®¡å£æ­» (ATN)ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | Protein: 2+ | Glucose: -" },
            { id: "oval_fat", image_file: "images/oval_fat.jpg", options: ["RTEC", "Oval Fat Body", "WBC", "RBC"], correct_index: 1, question: "ã€400xã€‘ç´°èƒå‘ˆåœ“å½¢ï¼Œèƒå…§æœ‰æ˜é¡¯è„‚è³ªæ²¹æ»´ (è„‚è‚ªåŒ–çš„ RTEC æˆ–å·¨å™¬ç´°èƒ)ã€‚", explanation: "<strong>Oval fat body</strong>ï¼šå¸¸è¦‹æ–¼è…ç—…ç—‡å€™ç¾¤ (Nephrotic syndrome)ï¼Œåå…‰ä¸‹å¯èƒ½æœ‰é¦¬è€³ä»–åå­—ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.5 | Protein: 4+ | Lipid: +" },
            { id: "rtec_cast", image_file: "images/rtec_cast.jpg", options: ["Granular Cast", "RTEC Cast", "WBC Cast", "Cellular Cast"], correct_index: 1, question: "ã€400xã€‘Cast å«æœ‰ 3 å€‹ä»¥ä¸Šçš„ RTECã€‚", explanation: "<strong>RTEC cast</strong>ï¼šåœ“æŸ±é«”å…§åŒ…å«è…å°ç®¡ä¸Šçš®ç´°èƒï¼Œæç¤ºè…å°ç®¡åš´é‡æå‚·ã€‚", stain_info: "400x / Low Light", chem_context: "pH: 5.5 | Protein: 2+" },
            { id: "rbc_cast", image_file: "images/rbc_cast.jpg", options: ["Heme Cast", "RBC Cast", "Granular Cast", "Waxy Cast"], correct_index: 1, question: "ã€400xã€‘Cast å«æœ‰ 3 å€‹ä»¥ä¸Šçš„ RBCã€‚", explanation: "<strong>RBC cast</strong>ï¼šåœ“æŸ±é«”å…§åŒ…åŸ‹ç´…è¡€çƒï¼Œç‚ºè…çµ²çƒè…ç‚ (Glomerulonephritis) çš„æŒ‡æ¨™ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | OB: 3+ | Protein: 2+" },
            { id: "wbc_cast", image_file: "images/wbc_cast.jpg", options: ["RTEC Cast", "WBC Cast", "Granular Cast", "Bacterial Cast"], correct_index: 1, question: "ã€400xã€‘Cast å«æœ‰ 3 å€‹ä»¥ä¸Šçš„ WBCã€‚", explanation: "<strong>WBC cast</strong>ï¼šåœ“æŸ±é«”å…§åŒ…åŸ‹ç™½è¡€çƒï¼Œå¼·çƒˆæç¤ºè…ç›‚è…ç‚ (Pyelonephritis)ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.5 | LE: 3+ | Protein: 1+" },
            { id: "waxy_cast", image_file: "images/waxy_cast.jpg", options: ["Hyaline Cast", "Waxy Cast", "Granular Cast", "Broad Cast"], correct_index: 1, question: "ã€400xã€‘é‚Šç·£æ¸…æ¥šã€å…·æ–·è£‚ç´‹ã€éåº¦è„«æ°´æˆè Ÿç‹€æ¨£åœ“æŸ±é«”ã€‚", explanation: "<strong>Waxy cast</strong>ï¼šè…è¡°ç«­åœ“æŸ±é«”ï¼Œæç¤ºå°¿æ¶²æ»¯ç•™æ¥µä¹…ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | Protein: 3+ | SG: Fixed" },
            { id: "fatty_cast", image_file: "images/fatty_cast.jpg", options: ["Granular Cast", "Fatty Cast", "Hyaline Cast", "Waxy Cast"], correct_index: 1, question: "ã€400xã€‘åŒ…æœ‰è„‚è³ªæ²¹æ»´çš„ castï¼Œåå…‰é¡¯å¾®é¡å¯è¦‹é¦¬è€³ä»–åå­—ç‰¹å¾µã€‚", explanation: "<strong>Fatty cast</strong>ï¼šè„‚è‚ªåœ“æŸ±é«”ï¼Œå¸¸è¦‹æ–¼è…ç—…ç—‡å€™ç¾¤ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | Protein: 4+" },
            { id: "bili_crys", image_file: "images/bili_crys.jpg", options: ["Uric Acid", "Bilirubin Crystal", "Tyrosine", "Leucine"], correct_index: 1, question: "ã€400xã€‘å°¿æ¶²éœ‡ç›ªå¾Œå…·æœ‰é»ƒè‰²æ³¡æ²«ï¼Œçµæ™¶é»ƒè‰²ã€å¤–å‹ä¼¼åˆºæœæˆ–è’²å…¬è‹±ç¨®å­çš„å† æ¯›ã€‚", explanation: "<strong>Bilirubin crystal</strong>ï¼šå‡ºç¾æ–¼åš´é‡è‚ç—…é˜»å¡æ€§é»ƒç–¸ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 5.5 | Bilirubin: 3+ | Foam: Yellow" },
            { id: "caox_di", image_file: "images/caox_di.jpg", options: ["Calcium Oxalate Monohydrate", "Calcium Oxalate Dihydrate", "Triple Phosphate", "Uric Acid"], correct_index: 1, question: "ã€400xã€‘å…«é¢é«”ã€ä¼¼çŸ­ç‰ˆè¥¿å¼ä¿¡å°ï¼Œå…·åå­—å…‰èŠ’ç‹€ã€‚", explanation: "<strong>Calcium oxalate dihydrate</strong>ï¼šé›™æ°´è‰é…¸éˆ£ï¼Œæœ€å¸¸è¦‹çš„çµæ™¶ä¹‹ä¸€ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0 | Clear Urine" },
            { id: "caox_mono", image_file: "images/caox_mono.jpg", options: ["Calcium Oxalate Monohydrate", "Calcium Oxalate Dihydrate", "RBC", "Yeast"], correct_index: 0, question: "ã€400xã€‘çµæ™¶å‘ˆåµåœ“å½¢æˆ–å•éˆ´å‹ã€‚", explanation: "<strong>Calcium oxalate monohydrate</strong>ï¼šå–®æ°´è‰é…¸éˆ£ï¼Œæ˜“èˆ‡ RBCæˆ–Ca. carbonate æ··æ·†ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0" },
            { id: "cap_col", image_file: "images/cap_col.jpg", options: ["Triple Phosphate", "Calcium Phosphate (Columnar)", "Tyrosine", "Ampicillin"], correct_index: 1, question: "ã€400xã€‘å¸¸è¦‹ç´°é•·ç¨œæŸ±ç‹€ï¼Œé¹¼æ€§å°¿å¯è¦‹ï¼Œèˆ‡æ³Œå°¿é“æ„ŸæŸ“çµçŸ³æœ‰é—œã€‚", explanation: "<strong>Calcium phosphate (Columnar)</strong>ï¼šæŸ±ç‹€ç£·é…¸éˆ£ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 7.5 | Nitrite: +" },
            { id: "cap_plate", image_file: "images/cap_plate.jpg", options: ["Cholesterol", "Calcium Phosphate (Plate)", "Cystine", "Uric Acid"], correct_index: 1, question: "ã€100xã€‘ç‰‡ç‹€å‹æ…‹çš„çµæ™¶ï¼Œé¹¼æ€§å°¿å¯è¦‹ï¼Œèˆ‡æ³Œå°¿é“æ„ŸæŸ“çµçŸ³æœ‰é—œã€‚", explanation: "<strong>Calcium phosphate (Plate)</strong>ï¼šç‰‡ç‹€ç£·é…¸éˆ£ï¼Œéœ€èˆ‡ Squamous Epi å€åˆ†ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 8.0" },
            { id: "trip_prism", image_file: "images/trip_prism.jpg", options: ["Ca Phos", "Triple Phosphate (Prism)", "Ca Carbonate", "Calcium Oxalate"], correct_index: 1, question: "ã€400xã€‘é¹¼æ€§å°¿å¯è¦‹ï¼Œç¨œæŸ±ç‹€å‹æ…‹ (Prism form)ã€‚", explanation: "<strong>Triple phosphate (Prism)</strong>ï¼šç£·é…¸éŠ¨é‚ï¼Œå¸¸è¦‹æ–¼æ„ŸæŸ“å°¿ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 8.5 | Nitrite: +" },
            { id: "trip_coffin", image_file: "images/trip_coffin.jpg", options: ["Calcium Oxalate", "Triple Phosphate (Coffin-lid)", "Uric Acid", "Cholesterol"], correct_index: 1, question: "ã€400xã€‘é¹¼æ€§å°¿å¯è¦‹ï¼Œå¸¸è¦‹é•·ç‰ˆè¥¿å¼ä¿¡å°ç‹€æˆ–æ£ºæè“‹æ¿å‹ï¼Œçµæ™¶æº¶è§£å¾Œå‘ˆè´è¶ç¿…è†€å‹æ…‹ã€‚", explanation: "<strong>Triple phosphate (Coffin-lid)</strong>ï¼šæ£ºæè“‹ç‹€ç£·é…¸éŠ¨é‚ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 8.0" },
            { id: "uric_acid", image_file: "images/uric_acid.jpg", options: ["Cystine", "Uric Acid", "Bilirubin", "Calcium Oxalate"], correct_index: 1, question: "ã€400xã€‘é…¸æ€§å°¿å¯è¦‹ï¼Œå‹æ…‹å¤šç¨®ï¼Œæœ‰æ¡¶å½¢ã€è±å½¢ã€è‘‰ç‰‡å½¢åŠæŸ±å½¢ç­‰ï¼Œçµæ™¶é¡è‰²åé»ƒã€‚", explanation: "<strong>Uric Acid</strong>ï¼šå°¿é…¸çµæ™¶ï¼Œç—›é¢¨æ‚£è€…å¸¸è¦‹ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 5.0" },
            { id: "fungus_yeast", image_file: "images/fungus_yeast.jpg", options: ["RBC", "Fungus (Yeast-like)", "Fungus (Mold-like)", "Bacteria"], correct_index: 1, question: "ã€400xã€‘å…·å‡ºèŠ½ç‹€ï¼Œå‹æ…‹ä¼¼ RBCï¼ŒåŠ ç¨€é‡‹é†‹é…¸ä¸è¢«æº¶è§£ã€‚", explanation: "<strong>Fungus Yeast-like</strong>ï¼šé¡é…µæ¯èŒ (Candida sp.)ï¼Œç³–å°¿ç—…å¸¸è¦‹ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 5.5 | Glucose: 3+" },
            { id: "fungus_mold", image_file: "images/fungus_mold.jpg", options: ["Mucus", "Fiber", "Fungus (Mold-like)", "Yeast-like"], correct_index: 2, question: "ã€400xã€‘é»´èŒèŒçµ²é«”ï¼Œå…·æœ‰ä¸­éš”çš„èŒçµ²éå¸¸æ˜é¡¯ã€‚", explanation: "<strong>Fungus mold-like</strong>ï¼šé»´èŒèŒçµ²ï¼Œå¸¸è¦‹æ–¼å…ç–«æŠ‘åˆ¶æ‚£è€…ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 6.0" },
            { id: "trich", image_file: "images/trich.jpg", options: ["WBC", "Trichomonas", "Bacteria", "RTEC"], correct_index: 1, question: "ã€400xã€‘æœ€å¸¸è¦‹çš„å°¿æ²‰æ¸£å¯„ç”ŸèŸ²ï¼Œä¼¼ç™½è¡€çƒå‹æ…‹ï¼Œå…·é­æ¯›ã€‚æ–°é®®å°¿æ¶²å¯è¦‹æ˜é¡¯æ¸¸å‹•ã€‚", explanation: "<strong>Trichomonas</strong>ï¼šé™°é“æ»´èŸ²ã€‚", stain_info: "400x / Unstained", chem_context: "pH: 7.0 | Leukocyte Esterase: 2+" },
            { id: "fiber", image_file: "images/fiber.jpg", options: ["Hyaline Cast", "Mucus", "Artificial Fibers", "Waxy Cast"], correct_index: 2, question: "ã€400xã€‘äººé€ çº–ç¶­ï¼Œå±¬å°¿æ²‰æ¸£é›œè³ªæˆåˆ†ã€‚", explanation: "<strong>Artificial fibers</strong>ï¼šä¾†è‡ªè¡£ç‰©æˆ–è¡›ç”Ÿç´™çš„çº–ç¶­ï¼ŒæŠ˜å…‰æ€§å¼·ï¼Œé‚Šç·£å¹³æ•´ã€‚", stain_info: "400x / Unstained", chem_context: "Sample Contaminated?" }
        ];

        // --- GAME LOGIC ---
        let currentMode = 'junior'; 
        let questionsToPlay = 10;
        let currentGameQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let answered = false;

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => {
                s.style.display = 'none';
                s.classList.remove('active');
            });
            const target = document.getElementById(screenId);
            if(target) {
                target.style.display = (screenId === 'start-screen' || screenId === 'result-screen') ? 'flex' : 'block';
                target.classList.add('active');
            }
        }

        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function startGame(mode) {
            currentMode = mode;
            score = 0;
            currentIdx = 0;
            answered = false;

            const root = document.documentElement;
            const badge = document.getElementById('mode-badge');
            
            if (mode === 'junior') {
                questionsToPlay = juniorPool.length; 
                root.style.setProperty('--primary-color', '#28a745');
                badge.innerText = "Junior (All 21)";
                badge.style.background = "#28a745";
                currentGameQuestions = shuffleArray([...juniorPool]);

            } else if (mode === 'advanced') {
                questionsToPlay = 20;
                root.style.setProperty('--primary-color', '#d63384');
                badge.innerText = "Advanced (Pure 20)";
                badge.style.background = "#d63384";
                const safeCount = Math.min(advancedPool.length, 20);
                questionsToPlay = safeCount;
                currentGameQuestions = shuffleArray([...advancedPool]).slice(0, questionsToPlay);

            } else { 
                questionsToPlay = 15;
                root.style.setProperty('--primary-color', '#e67e22');
                badge.innerText = "Quiz (Mixed 15)";
                badge.style.background = "#e67e22";
                const fullPool = [...juniorPool, ...advancedPool];
                currentGameQuestions = shuffleArray(fullPool).slice(0, questionsToPlay);
            }

            document.getElementById('score-text').innerText = "Score: 0";
            switchScreen('game-interface');
            loadQuestion();
        }

        function loadQuestion() {
            answered = false;
            const q = currentGameQuestions[currentIdx];
            
            document.getElementById('progress-text').innerText = `Q ${currentIdx + 1} / ${questionsToPlay}`;
            const pct = ((currentIdx) / questionsToPlay) * 100;
            document.getElementById('progress-bar').style.width = pct + "%";
            
            const imgEl = document.getElementById('question-image');
            const errorMsg = document.getElementById('error-msg');
            imgEl.style.display = 'block'; 
            errorMsg.style.display = 'none';
            imgEl.src = q.image_file;
            document.getElementById('missing-filename').innerText = q.image_file;

            const qText = document.getElementById('question-text');
            if (currentMode === 'quiz') {
                qText.innerHTML = `<div style="font-size:1.2rem; margin-bottom:5px;">${q.stain_info}</div><div class="lab-data-tag">${q.chem_context}</div>`;
            } else {
                qText.innerText = q.question;
            }

            const feedback = document.getElementById('feedback-panel');
            feedback.style.display = 'none';
            feedback.className = 'feedback-panel';
            document.getElementById('next-btn').style.display = 'none';

            let optionsWithStatus = q.options.map((opt, i) => ({
                text: opt,
                isCorrect: (i === q.correct_index)
            }));
            
            optionsWithStatus = shuffleArray(optionsWithStatus);

            const container = document.getElementById('options-container');
            container.innerHTML = "";
            
            optionsWithStatus.forEach((optData) => {
                const btn = document.createElement("button");
                btn.className = "option-btn";
                btn.innerText = optData.text;
                btn.dataset.isCorrect = optData.isCorrect;
                btn.onclick = () => handleAnswer(optData.isCorrect, btn);
                container.appendChild(btn);
            });
        }

        function handleImageError(img) {
            img.style.display = 'none';
            document.getElementById('error-msg').style.display = 'block';
        }

        function handleAnswer(isCorrect, btnElement) {
            if (answered) return;
            answered = true;
            const q = currentGameQuestions[currentIdx];
            const feedback = document.getElementById('feedback-panel');
            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.disabled = true);

            const pointsPerQ = 100 / questionsToPlay;

            if (isCorrect) {
                score += pointsPerQ;
                document.getElementById('score-text').innerText = `Score: ${Math.round(score)}`;
                btnElement.classList.add('correct');
                feedback.classList.add('success');
            } else {
                btnElement.classList.add('wrong');
                allBtns.forEach(b => {
                    if (b.dataset.isCorrect === "true") b.classList.add('correct');
                });
                feedback.classList.add('error');
            }

            const resultText = isCorrect ? "âœ… Correct!" : "âŒ Incorrect.";
            const correctOptionText = q.options[q.correct_index];

            if (currentMode === 'quiz') {
                 feedback.innerHTML = `<strong>${resultText}</strong><br>Answer: ${correctOptionText}`;
            } else {
                 feedback.innerHTML = `<strong>${resultText}</strong><br>${q.explanation}`;
            }

            feedback.style.display = 'block';
            
            const nextBtn = document.getElementById('next-btn');
            nextBtn.style.display = 'block';
            nextBtn.innerText = (currentIdx === questionsToPlay - 1) ? "View Results ğŸ“Š" : "Next Question â”";
        }

        function nextQuestion() {
            currentIdx++;
            if (currentIdx < questionsToPlay) {
                loadQuestion();
            } else {
                showResult();
            }
        }

        function showResult() {
            switchScreen('result-screen');
            let rank, comment;
            const finalScore = Math.round(score);
            document.getElementById('final-score').innerText = finalScore;
            
            if (currentMode === 'junior') {
                document.getElementById('result-title').innerText = "åˆç´šæ•™ç·´çµç®—";
            } else {
                document.getElementById('result-title').innerText = (currentMode === 'quiz') ? "æ¸¬é©—æ¨¡å¼çµç®—" : "é€²éšæ•™ç·´çµç®—";
            }

            if (finalScore >= 95) {
                rank = "ğŸ† é¡¯å¾®é¡å¤§å¸«";
                comment = "å¤ªå¼·äº†ï¼æ•™ç§‘æ›¸ç­‰ç´šçš„åˆ¤è®€èƒ½åŠ›ï¼";
            } else if (finalScore >= 80) {
                rank = "ğŸ¥ˆ è³‡æ·±é†«æª¢å¸«";
                comment = "è¡¨ç¾å„ªç•°ï¼Œå·²å…·å‚™è‡¨åºŠåˆ¤è®€æ°´æº–ã€‚";
            } else if (finalScore >= 60) {
                rank = "ğŸ¥‰ é†«æª¢å¸«";
                comment = "åŠæ ¼é€šéï¼Œä½†å»ºè­°å†é‡å°éŒ¯èª¤é¡Œç›®é€²è¡Œè¤‡ç¿’ã€‚";
            } else {
                rank = "ğŸ£ å¯¦ç¿’ç”Ÿ";
                comment = "åˆ¥æ°£é¤’ï¼Œæ²‰æ¸£åˆ¤è®€éœ€è¦ç¶“é©—ç´¯ç©ï¼Œå¤šç·´ç¿’å¹¾æ¬¡ï¼";
            }

            document.getElementById('final-rank').innerText = rank;
            document.getElementById('final-comment').innerText = comment;
        }

        function restartGame() { startGame(currentMode); }
        function goHome() { 
            document.documentElement.style.setProperty('--primary-color', '#0056b3');
            switchScreen('start-screen'); 
        }
    </script>
</body>
</html>